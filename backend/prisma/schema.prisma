// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AccountEmail {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AuthProvider {
  credentials
  google
  // Add others as needed
}

enum UserRole {
  super
  admin
  pic
  user
}

model TrustedDevice {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceId   String // Hashed device fingerprint
  deviceName String? // User-defined name
  deviceType String? // "mobile", "desktop", etc.
  os         String?
  browser    String?
  ipAddress  String?
  isRevoked  Boolean  @default(false)
  createdAt  DateTime @default(now())
  lastUsedAt DateTime @updatedAt

  @@unique([userId, deviceId])
}

// Authentication Models
model User {
  id             String       @id @default(uuid())
  email          String       @unique
  password       String?
  name           String?
  mfaSecret      String?
  mfaEnabled     Boolean      @default(false)
  mfaBackupCodes String[]
  avatar         String?
  googleId       String?      @unique
  provider       AuthProvider @default(credentials)
  role           UserRole
  tokenVersion   Int          @default(0)
  lastLoginAt    DateTime?
  failedAttempts Int          @default(0)
  lockedUntil    DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  active         Boolean      @default(true)

  trustedDevices   TrustedDevice[]
  sessions         UserSession[]
  loginAttempts    LoginAttempt[]
  salesOrders      SalesOrder[]    @relation("UserSalesOrders")
  karyawan         Karyawan?
  createdBAP       BAP[]           @relation("BAPCreatedBy") // semua BAP yang dibuat user ini
  createdInvoices  Invoice[]       @relation("InvoiceCreatedBy")
  verifiedPayments Payment[]
}

model LoginAttempt {
  id        String   @id @default(uuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  email     String
  status    String // "SUCCESS", "FAILED", "MFA_REQUIRED"
  ipAddress String
  userAgent String?
  deviceId  String? // Device fingerprint
  reason    String? // "WRONG_PASSWORD", "ACCOUNT_LOCKED"
  createdAt DateTime @default(now())

  @@index([email])
  @@index([ipAddress])
}

model UserSession {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionToken String   @unique
  refreshToken String   @unique
  deviceId     String? // Link to TrustedDevice if recognized
  ipAddress    String
  userAgent    String
  country      String? // Geolocation data
  city         String?
  isRevoked    Boolean  @default(false)
  createdAt    DateTime @default(now())
  expiresAt    DateTime

  @@index([userId])
  @@index([expiresAt])
}

model Counter {
  name       String   @id
  lastNumber Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Karyawan {
  id            String    @id @default(cuid())
  nik           String    @unique // Nomor Induk Karyawan
  namaLengkap   String
  tanggalLahir  DateTime?
  alamat        String?
  nomorTelepon  String?
  email         String?   @unique
  jabatan       String?
  departemen    String?
  tanggalMasuk  DateTime?
  tanggalKeluar DateTime? // jika resign atau kontrak selesai
  statusKerja   String // "aktif", "non-aktif", "cuti", dll
  foto          String?
  // Data kontrak / HR
  tipeKontrak   String? // "kontrak", "tetap", "magang"
  gajiPokok     Float?
  tunjangan     Float?
  potongan      Float?
  isActive      Boolean   @default(true)

  // Relasi ke User untuk login ERP
  user   User?   @relation(fields: [userId], references: [id])
  userId String? @unique

  // Relasi ke Team
  teamKaryawan TeamKaryawan[]

  // Relasi ke penggajian
  gaji             Gaji[]
  spkDetail        SPKDetail[]
  spk              SPK[]            @relation("SPKCreatedBy")
  spkFieldReport   SPKFieldReport[]
  approvedBAP      BAP[]            @relation("BAPApprovedBy") // semua BAP yang di-approve user ini
  approvedInvoices Invoice[]        @relation("InvoiceApprovedBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Gaji {
  id         String   @id @default(cuid())
  karyawan   Karyawan @relation(fields: [karyawanId], references: [id])
  karyawanId String
  periode    DateTime // misal: awal bulan
  gajiPokok  Float
  tunjangan  Float?
  potongan   Float?
  total      Float // otomatis hitung: gajiPokok + tunjangan - potongan
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Customer {
  id            String  @id @default(uuid())
  code          String  @unique // kode unik customer, misal: CUST-001
  name          String // nama customer
  email         String? @unique // kontak email utama
  phone         String? // nomor telepon utama
  address       String? // alamat lengkap
  branch        String? // cabang jika ada
  city          String? // kota
  province      String? // provinsi
  postalCode    String? // kode pos
  taxNumber     String? // NPWP / Tax ID
  companyType   String? // tipe perusahaan: PT, CV, dll
  contactPerson String? // nama PIC utama
  picPhone      String? // kontak PIC
  picEmail      String? // email PIC
  notes         String? // catatan tambahan

  isActive  Boolean  @default(true) // aktif/nonaktif
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  projects    Project[]
  salesOrders SalesOrder[]
  quotations  Quotation[]
}

model Project {
  id         String   @id @default(uuid())
  customerId String
  name       String
  location   String?
  createdAt  DateTime @default(now())

  customer    Customer     @relation(fields: [customerId], references: [id])
  salesOrders SalesOrder[]
}

model Product {
  id          String      @id @default(uuid())
  code        String      @unique // Kode produk/SKU
  name        String // Nama produk
  description String? // Deskripsi produk
  type        ProductType // Material, Jasa, Alat, dll

  purchaseUnit String // Satuan pembelian (misal: roll)
  storageUnit  String // Satuan penyimpanan (misal: roll)
  usageUnit    String // Satuan penggunaan (misal: meter)

  conversionToStorage Decimal // Dari pembelian → penyimpanan (contoh: 1 karton = 10 roll → 10)
  conversionToUsage   Decimal // Dari penyimpanan → penggunaan (contoh: 1 roll = 100 meter → 100)

  isConsumable Boolean @default(true) // True jika habis pakai
  isActive     Boolean @default(true)
  image        String? // URL gambar produk
  barcode      String? // Optional barcode / QR

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Optional kategori
  categoryId String?
  category   ProductCategory? @relation(fields: [categoryId], references: [id])

  // Relasi
  salesOrderItems SalesOrderItem[]
  QuotationLines  QuotationLine[]
}

enum ProductType {
  Material // tetap
  Jasa // tetap
  Alat // tetap

  FinishedGoods // Barang Jadi
  SparePart // Suku Cadang
  Consumable // Bahan Habis Pakai
  Asset // Aset tetap
  Rental // Penyewaan
  Software // Produk digital
  Packaging // Kemasan
  MRO // Maintenance, Repair, Operation

  Scrap // Barang bekas sisa produksi / customer
  Refurbished // Barang bekas diperbaiki agar bisa dipakai
  Return // Barang retur dari customer
}

model ProductCategory {
  id       String    @id @default(uuid())
  name     String    @unique
  products Product[]
}

// ENUM
enum QuotationStatus {
  DRAFT
  SENT
  REVIEW
  APPROVED
  REJECTED
  EXPIRED
  CANCELLED
}

enum LineType {
  PRODUCT
  SERVICE
  FREIGHT
  OTHER
}

enum DiscountType {
  PERCENT
  AMOUNT
}

// MODEL
model Quotation {
  id              String @id @default(uuid())
  quotationNumber String @unique // Nomor penawaran
  version         Int    @default(1)

  // Relasi ke customer
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  currency     String  @default("IDR")
  exchangeRate Decimal @default(1.0)

  status QuotationStatus @default(DRAFT)

  validFrom  DateTime?
  validUntil DateTime?

  paymentTermId String?
  paymentTerm   PaymentTerm? @relation(fields: [paymentTermId], references: [id])

  // Nilai perhitungan
  subtotal      Decimal      @default(0)
  discountType  DiscountType @default(PERCENT)
  discountValue Decimal      @default(0) // bisa % atau amount
  taxInclusive  Boolean      @default(false)
  taxTotal      Decimal      @default(0)
  otherCharges  Decimal      @default(0)
  total         Decimal      @default(0)

  notes      String?
  preparedBy String? // user id
  approvedBy String?
  approvedAt DateTime?

  // Relasi ke item
  lines QuotationLine[]

  // Relasi ke history/approval/attachment
  histories   QuotationHistory[]
  approvals   QuotationApproval[]
  attachments QuotationAttachment[]
  comments    QuotationComment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model QuotationLine {
  id          String    @id @default(uuid())
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id])

  lineNo   Int
  lineType LineType @default(PRODUCT)

  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  description String?
  qty         Decimal @default(1)
  uom         String?
  unitPrice   Decimal @default(0)

  lineDiscountType  DiscountType @default(PERCENT)
  lineDiscountValue Decimal      @default(0)

  lineSubtotal Decimal @default(0)
  taxId        String?
  tax          Tax?    @relation(fields: [taxId], references: [id])
  taxAmount    Decimal @default(0)
  lineTotal    Decimal @default(0)

  createdAt DateTime @default(now())
}

model QuotationHistory {
  id          String    @id @default(uuid())
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id])
  version     Int
  changedBy   String?
  changeAt    DateTime  @default(now())
  changeNote  String?
  payload     Json
}

model QuotationApproval {
  id          String          @id @default(uuid())
  quotationId String
  quotation   Quotation       @relation(fields: [quotationId], references: [id])
  approverId  String?
  sequence    Int             @default(1)
  status      QuotationStatus @default(REVIEW)
  notes       String?
  actedAt     DateTime?
}

model QuotationAttachment {
  id          String    @id @default(uuid())
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id])
  fileName    String
  filePath    String
  fileSize    Int?
  uploadedBy  String?
  uploadedAt  DateTime  @default(now())
}

model QuotationComment {
  id          String    @id @default(uuid())
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id])
  commentedBy String?
  comment     String
  createdAt   DateTime  @default(now())
}

model Tax {
  id          String  @id @default(uuid())
  code        String  @unique // Misal: PPN, VAT10, PPh23
  name        String // Nama pajak (misal: "PPN 11%", "PPh Pasal 23")
  description String? // Penjelasan tambahan

  rate        Decimal // Persentase (contoh: 11.00 untuk 11%)
  isInclusive Boolean @default(false) // true = harga sudah termasuk pajak, false = harga belum termasuk pajak
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relasi ke transaksi
  quotationItems QuotationLine[] // Pajak di Penawaran Harga
}

model PaymentTerm {
  id          String  @id @default(uuid())
  code        String  @unique // Kode unik (misal: NET30, COD)
  name        String // Nama syarat pembayaran (misal: "Net 30 Hari", "Cash On Delivery")
  description String? // Penjelasan tambahan

  dueDays  Int // Jangka waktu pembayaran (contoh: 30 → berarti jatuh tempo 30 hari setelah invoice)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relasi ke transaksi
  quotations Quotation[] // Bisa dipakai di Penawaran Harga
}

// ================== ENUMS ==================
enum OrderType {
  REGULAR
  SUPPORT
}

enum OrderStatus {
  DRAFT
  CONFIRMED
  IN_PROGRESS_SPK
  FULFILLED
  BAST
  PARTIALLY_INVOICED
  INVOICED
  PARTIALLY_PAID
  PAID
  CANCELLED
}

enum ItemType {
  PRODUCT
  SERVICE
  CUSTOM
}

enum DocType {
  QUOTATION
  PO
  SPK
  BAP
  INVOICE
  PAYMENT_RECEIPT
}

// ================== MODELS ==================
model SalesOrder {
  id             String      @id @default(uuid())
  soNumber       String      @unique
  soDate         DateTime
  customerId     String
  projectId      String // <-- wajib
  userId         String
  type           OrderType
  status         OrderStatus @default(DRAFT)
  isTaxInclusive Boolean     @default(false)

  currency      String  @default("IDR")
  subtotal      Decimal @default(0) @db.Decimal(18, 2)
  discountTotal Decimal @default(0) @db.Decimal(18, 2)
  taxTotal      Decimal @default(0) @db.Decimal(18, 2)
  grandTotal    Decimal @default(0) @db.Decimal(18, 2)

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  project  Project  @relation(fields: [projectId], references: [id], onDelete: Restrict, onUpdate: Cascade) // <-- Restrict karena FK wajib
  user     User     @relation("UserSalesOrders", fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  items     SalesOrderItem[]
  documents SalesOrderDocument[]
  invoices  Invoice[]
  spk       SPK[]
  bap       BAP[]

  @@index([customerId, soDate])
  @@index([status])
  @@index([projectId])
}

model SalesOrderItem {
  id           String   @id @default(uuid())
  salesOrderId String
  lineNo       Int
  itemType     ItemType @default(PRODUCT)

  productId   String?
  name        String
  description String?
  uom         String?
  qty         Decimal @db.Decimal(18, 4)
  unitPrice   Decimal @db.Decimal(18, 2)
  discount    Decimal @default(0) @db.Decimal(18, 2)
  taxRate     Decimal @default(0) @db.Decimal(5, 2)
  lineTotal   Decimal @default(0) @db.Decimal(18, 2)

  salesOrder   SalesOrder       @relation(fields: [salesOrderId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  product      Product?         @relation(fields: [productId], references: [id], onDelete: SetNull, onUpdate: Cascade) // ← nullable
  spkDetail    SPKDetail[]
  fieldReports SPKFieldReport[] @relation("SPKDetailToFieldReport")

  @@index([salesOrderId])
  @@index([productId])
}

model SalesOrderDocument {
  id           String    @id @default(uuid())
  salesOrderId String
  docType      DocType
  docNumber    String?
  docDate      DateTime?
  fileUrl      String?
  meta         Json?
  createdAt    DateTime  @default(now())

  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([salesOrderId, docType])
}

model TeamKaryawan {
  id         String   @id @default(cuid())
  team       Team     @relation(fields: [teamId], references: [id])
  teamId     String
  karyawan   Karyawan @relation(fields: [karyawanId], references: [id])
  karyawanId String
}

model Team {
  id        String         @id @default(cuid())
  namaTeam  String
  deskripsi String?
  karyawan  TeamKaryawan[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  spk SPK[]
}

model SPK {
  id        String   @id @default(uuid())
  spkNumber String   @unique // Nomor SPK
  spkDate   DateTime @default(now())
  progress  Int?     @default(0)

  // Yang memberi perintah
  createdById String
  createdBy   Karyawan @relation("SPKCreatedBy", fields: [createdById], references: [id])

  // Relasi ke Sales Order
  salesOrderId String
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  // Tim yang menerima perintah (optional, bisa juga langsung ke karyawan)
  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id])

  // Detail SPK
  details        SPKDetail[]
  spkFieldReport SPKFieldReport[]
  spkStatus      Boolean          @default(false)
  spkStatusClose Boolean          @default(false)
  notes          String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
}

model SPKDetail {
  id    String @id @default(uuid())
  spkId String
  spk   SPK    @relation(fields: [spkId], references: [id], onDelete: Cascade)

  karyawanId String?
  karyawan   Karyawan? @relation(fields: [karyawanId], references: [id])

  salesOrderItemId String?
  salesOrderItem   SalesOrderItem? @relation(fields: [salesOrderItemId], references: [id])

  lokasiUnit String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ReportType {
  PROGRESS
  FINAL
}

enum ReportStatus {
  PENDING
  APPROVED
  REJECTED
}

model SPKFieldReport {
  id         String                @id @default(uuid())
  spkId      String
  spk        SPK                   @relation(fields: [spkId], references: [id], onDelete: Cascade)
  karyawanId String
  karyawan   Karyawan              @relation(fields: [karyawanId], references: [id])
  type       ReportType            @default(PROGRESS)
  note       String?
  reportedAt DateTime              @default(now())
  progress   Int?                  @default(0)
  status     ReportStatus          @default(PENDING)
  photos     SPKFieldReportPhoto[]
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt

  soDetailId String?
  soDetail   SalesOrderItem? @relation("SPKDetailToFieldReport", fields: [soDetailId], references: [id], onDelete: SetNull)
}

model SPKFieldReportPhoto {
  id         String         @id @default(uuid())
  reportId   String
  report     SPKFieldReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  imageUrl   String
  caption    String?
  uploadedBy String
  uploadedAt DateTime       @default(now())
  latitude   Float?
  longitude  Float?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
}

model BAP {
  id           String   @id @default(uuid())
  bapNumber    String   @unique
  bapDate      DateTime
  salesOrderId String
  projectId    String

  // Pembuat dokumen
  createdById String
  createdBy   User   @relation("BAPCreatedBy", fields: [createdById], references: [id], onDelete: Restrict, onUpdate: Cascade)

  // Penanggung jawab / approver
  userId String
  user   Karyawan @relation("BAPApprovedBy", fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  // Informasi pekerjaan
  workDescription String?
  location        String?

  // Status
  status     BAPStatus @default(DRAFT)
  isApproved Boolean   @default(false)
  approvedAt DateTime?

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  photos     BAPPhoto[]

  @@index([salesOrderId])
  @@index([bapNumber])
  @@index([status])
}

model BAPPhoto {
  id        String        @id @default(uuid())
  bapId     String
  photoUrl  String
  caption   String?
  category  PhotoCategory // tambahan ini
  createdAt DateTime      @default(now())
  source    String? // "SPK" atau "MANUAL"

  bap BAP @relation(fields: [bapId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([bapId])
  @@index([category])
}

enum PhotoCategory {
  BEFORE
  PROCESS
  AFTER
}

enum BAPStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  APPROVED
}

// ENUM Definitions
enum InvoiceStatus {
  DRAFT
  WAITING_APPROVAL
  APPROVED
  REJECTED
  UNPAID
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PaymentMethod {
  TRANSFER
  CASH
  CREDIT_CARD
  VA
  E_WALLET
  CHEQUE
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum InstallmentStatus {
  PENDING
  DUE_SOON
  OVERDUE
  PARTIALLY_PAID
  PAID
}

// ================== (Opsional tapi direkomendasikan) ==================
model BankAccount {
  id            String  @id @default(uuid())
  bankName      String
  accountNumber String  @unique
  accountHolder String
  branch        String?
  isActive      Boolean @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  invoice   Invoice[]
  payment   Payment[]
}

model Invoice {
  id            String   @id @default(uuid())
  invoiceNumber String   @unique
  invoiceDate   DateTime
  dueDate       DateTime // Tanggal jatuh tempo
  salesOrderId  String?
  currency      String   @default("IDR")
  exchangeRate  Decimal  @default(1) @db.Decimal(18, 6) // Untuk multi-currency
  bankAccountId String?

  // Termin informasi
  paymentTerm     String? // NET_30, NET_60, dll
  installmentType String  @default("FULL") // FULL, INSTALLMENT
  totalAmount     Decimal @default(0) @db.Decimal(18, 2) // Total amount sebelum termin

  // Breakdown amounts
  subtotal      Decimal @default(0) @db.Decimal(18, 2)
  discountTotal Decimal @default(0) @db.Decimal(18, 2)
  taxTotal      Decimal @default(0) @db.Decimal(18, 2)
  grandTotal    Decimal @default(0) @db.Decimal(18, 2)
  paidTotal     Decimal @default(0) @db.Decimal(18, 2) // Total yang sudah dibayar
  balanceDue    Decimal @default(0) @db.Decimal(18, 2) // Sisa yang harus dibayar

  // Status workflow
  status         InvoiceStatus  @default(WAITING_APPROVAL)
  approvalStatus ApprovalStatus @default(PENDING)

  // Tracking informasi
  notes           String?
  internalNotes   String? // Catatan internal untuk tim finance
  termsConditions String? // Syarat dan ketentuan invoice

  // User tracking
  createdById    String
  approvedById   String?
  rejectedById   String?
  rejectedReason String?

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  approvedAt DateTime?

  // Relations
  salesOrder   SalesOrder?   @relation(fields: [salesOrderId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  items        InvoiceItem[]
  payments     Payment[]
  installments Installment[] // Termin pembayaran
  createdBy    User          @relation("InvoiceCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  approvedBy   Karyawan?     @relation("InvoiceApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  invoiceTax   InvoiceTax[]
  bankAccount  BankAccount?  @relation(fields: [bankAccountId], references: [id])

  @@index([salesOrderId])
  @@index([createdById])
  @@index([status])
  @@index([dueDate])
  @@index([invoiceDate])
}

model InvoiceItem {
  id        String  @id @default(uuid())
  invoiceId String
  soItemId  String?

  // Item details
  itemCode    String? // Kode item dari master data
  name        String
  description String?
  uom         String?

  // Quantity dan harga
  qty             Decimal @db.Decimal(18, 4)
  unitPrice       Decimal @db.Decimal(18, 2)
  discount        Decimal @default(0) @db.Decimal(18, 2)
  discountPercent Decimal @default(0) @db.Decimal(5, 2)

  // Tax information
  taxRate Decimal @default(0) @db.Decimal(5, 2)
  taxCode String? // PPN, PPH23, dll
  taxable Boolean @default(true)

  // Calculated fields
  lineTotal Decimal @default(0) @db.Decimal(18, 2)
  taxAmount Decimal @default(0) @db.Decimal(18, 2)
  netAmount Decimal @default(0) @db.Decimal(18, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([invoiceId])
  @@index([itemCode])
}

model Payment {
  id            String  @id @default(uuid())
  invoiceId     String
  installmentId String? // Link ke installment jika bayar termin

  // Payment details
  payDate      DateTime
  amount       Decimal  @db.Decimal(18, 2)
  currency     String   @default("IDR")
  exchangeRate Decimal  @default(1) @db.Decimal(18, 6)

  // Payment method
  method        PaymentMethod // TRANSFER, CASH, CREDIT_CARD, VA, E_WALLET
  bankAccountId String? // Rekening tujuan
  reference     String? // No. bukti, VA number, settlement id

  // Status
  status       PaymentStatus @default(PENDING) // PENDING, COMPLETED, FAILED, CANCELLED
  verified     Boolean       @default(false)
  verifiedById String?
  verifiedAt   DateTime?

  // Additional info
  notes      String?
  attachment String? // URL bukti pembayaran

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  invoice     Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  installment Installment? @relation(fields: [installmentId], references: [id], onDelete: SetNull)
  verifiedBy  User?        @relation(fields: [verifiedById], references: [id], onDelete: SetNull)
  bankAccount BankAccount? @relation(fields: [bankAccountId], references: [id])

  @@index([invoiceId, payDate])
  @@index([status])
  @@index([reference])
}

model Installment {
  id                String @id @default(uuid())
  invoiceId         String
  installmentNumber Int // 1, 2, 3, ...
  name              String // DP, After Installation, Final, dll

  // Amount details
  amount     Decimal  @db.Decimal(18, 2)
  percentage Decimal? @db.Decimal(5, 2) // Persentase dari total

  // Due date dan status
  dueDate DateTime
  status  InstallmentStatus @default(PENDING) // PENDING, DUE_SOON, OVERDUE, PARTIALLY_PAID, PAID

  // Tracking pembayaran
  paidAmount Decimal   @default(0) @db.Decimal(18, 2)
  balance    Decimal   @default(0) @db.Decimal(18, 2)
  paidAt     DateTime?

  // Description
  description String?
  conditions  String? // Kondisi yang harus dipenuhi sebelum bayar

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  invoice  Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  payments Payment[]

  @@index([invoiceId])
  @@index([dueDate])
  @@index([status])
}

// Tabel terpisah untuk tax summary jika diperlukan reporting detail
model InvoiceTax {
  id            String  @id @default(uuid())
  invoiceId     String
  taxCode       String // PPN, PPH23, dll
  taxRate       Decimal @db.Decimal(5, 2)
  taxableAmount Decimal @db.Decimal(18, 2)
  taxAmount     Decimal @db.Decimal(18, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([invoiceId])
  @@index([taxCode])
}
